az group create --name AgileMeterRG --location francecentral

az aks create --resource-group AgileMeterRG --name AgileMeterCluster --enable-addons monitoring --kubernetes-version 1.12.8 --generate-ssh-keys --location francecentral

##Azure login alberto.muriel.devops@hotmail.com
az login -u alberto.muriel.devops@hotmail.com -p Passw0rd10!

##Cluster role Binding
kubectl create clusterrolebinding kubernetes-dashboard -n kube-system --clusterrole=cluster-admin --serviceaccount=kube-system:kubernetes-dashboard

##Get Credentials 
az aks get-credentials --resource-group AgileMeterRG --name AgileMeterCluster

##Create Kubernetes user role
C:\Windows\System32\cmd.exe
kubectl apply -f dashboard-adminuser.yaml
kubectl apply -f dashboard-serviceaccount.yml

--Get Secret Token from 


##Browse AKS Kubernetes Dashboard
az aks browse --resource-group AgileMeterRG --name AgileMeterCluster --subscription "Evaluación gratuita" --listen-port 8010



------------------
az acr create --resource-group AgileMeterRG --name amapifront --sku Basic --admin-enabled=true
az acr create --resource-group AgileMeterRG --name amapiback --sku Basic --admin-enabled=true
az acr create --resource-group AgileMeterRG --name amapidatabase --sku Basic --admin-enabled=true
------------------
az acr credential show -g AgileMeterRG -n amapifront
az acr credential show -g AgileMeterRG -n amapiback
az acr credential show -g AgileMeterRG -n amapidatabase
------------------
username: amapifront
name: password
Och0fEz/0mFFmhCRQWAgPihvqWm3PfS3
password2
eGpSYoL4wyyAVFlWzTQScptT=WL7Kh2x

user: amapiback
password
mrzg3koI9/h4jdvrU4EBkvZLu0mANK5l
password2
Vrt8Woy4MbR9G9PQS9Y8zV/YOkKxgpfE

user: amapidatabase
password
twN=NvwcKMXccHC1gYPBQphAR0l62RtY
password2
qSqJtblwK/fO8aT46lxDQhVLt1qG9cYv
-----------------

##TAG IMAGES AND PUSH IMAGES TO AZURE
##Azure Registry - alberto.muriel.devops@hotmail.com

docker login amapifront.azurecr.io -u amapifront -p Och0fEz/0mFFmhCRQWAgPihvqWm3PfS3
docker tag fee65d59edc1  amapifront.azurecr.io/agilemeterfront_dev:latest
docker push amapifront.azurecr.io/agilemeterfront_dev:latest

docker login amapiback.azurecr.io -u amapiback -p mrzg3koI9/h4jdvrU4EBkvZLu0mANK5l
docker tag a6e6d8447771 amapiback.azurecr.io/agilemeter_dev:latest
docker push amapiback.azurecr.io/agilemeter_dev:latest

docker login amapidatabase.azurecr.io -u amapidatabase -p twN=NvwcKMXccHC1gYPBQphAR0l62RtY
docker tag 50c7aa33be23 amapidatabase.azurecr.io/agiledatabase_dev:latest
docker push amapidatabase.azurecr.io/agiledatabase_dev:latest


##CHECK REGISTRY REPOSITORY IMAGES IN AZURE
az acr login --name amapifront -u amapifront -p Och0fEz/0mFFmhCRQWAgPihvqWm3PfS3
az acr repository list --name amapifront --output table
az acr login --name amapiback -u amapiback -p mrzg3koI9/h4jdvrU4EBkvZLu0mANK5l
az acr repository list --name amapiback --output table
az acr login --name amapidatabase -u amapidatabase -p twN=NvwcKMXccHC1gYPBQphAR0l62RtY
az acr repository list --name amapidatabase --output table

## REGISTRY REPOSITORY IMAGES IN AZURE
az acr repository list --name amapifront --output table
az acr repository list --name amapiback --output table
az acr repository list --name amapidatabase --output table




########### AKS DASHBOARD ###########

##Cluster role Binding
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml
kubectl create clusterrolebinding kubernetes-dashboard -n kube-system --clusterrole=cluster-admin --serviceaccount=kube-system:kubernetes-dashboard

##Get Credentials 
az aks get-credentials --resource-group AgileMeterRG --name AgileMeterCluster

##Browse AKS Kubernetes Dashboard
az aks browse --resource-group AgileMeterRG --name AgileMeterCluster --subscription "Evaluación gratuita" --listen-port 8010


##AKS Secrets

kubectl create secret docker-registry amapifront-regsecret --docker-server=amapifront.azurecr.io --docker-username=amapifront --docker-password=Och0fEz/0mFFmhCRQWAgPihvqWm3PfS3 --docker-email=alberto.muriel.devops@hotmail.com
kubectl create secret docker-registry amapiback-regsecret --docker-server=amapiback.azurecr.io --docker-username=amapiback --docker-password=mrzg3koI9/h4jdvrU4EBkvZLu0mANK5l --docker-email=alberto.muriel.devops@hotmail.com
kubectl create secret docker-registry amapidatabase-regsecret --docker-server=amapidatabase.azurecr.io --docker-username=amapidatabase --docker-password=twN=NvwcKMXccHC1gYPBQphAR0l62RtY --docker-email=alberto.muriel.devops@hotmail.com

##POD uses secret
# https://github.com/andyzhangx/demo/tree/master/linux/secret#2-use-secret-to-pull-an-image-from-an-azure-private-registry
# https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/



##ENABLE AND SHOW HTTP ROUTING TO MAKE APPS AVAILABLE FROM OUTSIDE
# https://docs.microsoft.com/es-es/azure/aks/http-application-routing
#bb993df2c6c84831a0b6.westeurope.aksapp.io

az aks enable-addons --resource-group AgileMeterRG --name AgileMeterCluster --addons http_application_routing
az aks show --resource-group AgileMeterRG --name AgileMeterCluster --query addonProfiles.httpApplicationRouting.config.HTTPApplicationRoutingZoneName -o table



##DEPLOY PODS, REPLICA SETS, SERVICES, PVC ON AKS
#------------------TBC-------IMPORTANT!!!!
kubectl apply -f docker-compose-AKS\templates\agiledatabase-deployment.yaml --validate=false


 kubectl port-forward pod/agilemeterfront-7fcff755fb-4krgr 4200:4200
 
 
 
 
 
 